<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserStorageAccessServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">VPS</a> &gt; <a href="index.source.html" class="el_package">com.example.warehouse.service</a> &gt; <span class="el_source">UserStorageAccessServiceImpl.java</span></div><h1>UserStorageAccessServiceImpl.java</h1><pre class="source lang-java linenums">package com.example.warehouse.service;

import com.example.warehouse.dto.UserStorageAccessDTO;
import com.example.warehouse.entity.UserStorageAccess;
import com.example.warehouse.entity.User;
import com.example.warehouse.entity.Storage;
import com.example.warehouse.enumeration.AccessLevel;
import com.example.warehouse.exception.UserStorageAccessNotFoundException;
import com.example.warehouse.exception.UserNotFoundException;
import com.example.warehouse.exception.StorageNotFoundException;
import com.example.warehouse.exception.DuplicateUserStorageAccessException;
import com.example.warehouse.exception.OperationNotAllowedException;
import com.example.warehouse.mapper.UserStorageAccessMapper;
import com.example.warehouse.repository.UserStorageAccessRepository;
import com.example.warehouse.repository.UserRepository;
import com.example.warehouse.repository.StorageRepository;
import com.example.warehouse.service.interfaces.StorageService;
import com.example.warehouse.service.interfaces.UserService;
import com.example.warehouse.service.interfaces.UserStorageAccessService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

<span class="fc" id="L34">@Slf4j</span>
@Service

@RequiredArgsConstructor
public class UserStorageAccessServiceImpl implements UserStorageAccessService {

    private final UserStorageAccessRepository userStorageAccessRepository;
    private final UserService userService;
    private final StorageService storageService;

    @Override
    public UserStorageAccess create(UserStorageAccess userStorageAccess) {

<span class="nc" id="L47">        User user = userService.getUserById(userStorageAccess.getUser().getId());</span>

<span class="nc" id="L49">        Storage storage = storageService.getById(userStorageAccess.getStorage().getId());</span>

<span class="nc" id="L51">        User grantedBy = userService.getUserById(userStorageAccess.getGrantedBy().getId());</span>

<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (userStorageAccessRepository.existsByUserIdAndStorageId(userStorageAccess.getUser().getId(), userStorageAccess.getStorage().getId())) {</span>
<span class="nc" id="L54">            throw new DuplicateUserStorageAccessException(</span>
<span class="nc" id="L55">                    &quot;User storage access already exists for user ID: &quot; + userStorageAccess.getUser().getId() +</span>
<span class="nc" id="L56">                            &quot; and storage ID: &quot; + userStorageAccess.getStorage().getId());</span>
        }

<span class="nc bnc" id="L59" title="All 4 branches missed.">        if (userStorageAccess.getExpiresAt() != null &amp;&amp; userStorageAccess.getExpiresAt().isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L60">            throw new OperationNotAllowedException(&quot;Expiration date must be in the future&quot;);</span>
        }


<span class="nc" id="L64">        userStorageAccess.setUser(user);</span>
<span class="nc" id="L65">        userStorageAccess.setStorage(storage);</span>
<span class="nc" id="L66">        userStorageAccess.setGrantedBy(grantedBy);</span>
<span class="nc" id="L67">        userStorageAccess.setGrantedAt(LocalDateTime.now());</span>

<span class="nc" id="L69">        UserStorageAccess savedAccess = userStorageAccessRepository.save(userStorageAccess);</span>
<span class="nc" id="L70">        log.info(&quot;User storage access created successfully with ID: {}&quot;, savedAccess.getId());</span>

<span class="nc" id="L72">        return savedAccess;</span>
    }

    @Override
    public UserStorageAccess getById(Long id) {
<span class="nc" id="L77">        log.debug(&quot;Fetching user storage access by ID: {}&quot;, id);</span>

<span class="nc" id="L79">        return userStorageAccessRepository.findById(id)</span>
<span class="nc" id="L80">                .orElseThrow(() -&gt; new UserStorageAccessNotFoundException(&quot;User storage access not found with ID: &quot; + id));</span>
    }

    @Override
    public void update(Long id, UserStorageAccess userStorageAccess) {
<span class="nc" id="L85">        log.info(&quot;Updating user storage access with ID: {}&quot;, id);</span>

        try {
<span class="nc" id="L88">            UserStorageAccess existingAccess = userStorageAccessRepository.findById(id)</span>
<span class="nc" id="L89">                    .orElseThrow(() -&gt; new UserStorageAccessNotFoundException(&quot;User storage access not found with ID: &quot; + id));</span>

<span class="nc bnc" id="L91" title="All 4 branches missed.">            if (userStorageAccess.getExpiresAt() != null &amp;&amp; userStorageAccess.getExpiresAt().isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L92">                throw new OperationNotAllowedException(&quot;Expiration date must be in the future&quot;);</span>
            }

<span class="nc" id="L95">            updateRelatedEntities(existingAccess, userStorageAccess);</span>

<span class="nc" id="L97">            existingAccess.setAccessLevel(userStorageAccess.getAccessLevel());</span>
<span class="nc" id="L98">            existingAccess.setExpiresAt(userStorageAccess.getExpiresAt());</span>
<span class="nc" id="L99">            existingAccess.setIsActive(userStorageAccess.getIsActive());</span>

<span class="nc" id="L101">            userStorageAccessRepository.save(existingAccess);</span>
<span class="nc" id="L102">            log.info(&quot;User storage access with ID: {} updated successfully&quot;, id);</span>

<span class="nc" id="L104">        } catch (DataIntegrityViolationException e) {</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">            if (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;uk_user_storage_access&quot;)) {</span>
<span class="nc" id="L106">                throw new DuplicateUserStorageAccessException(</span>
<span class="nc" id="L107">                        &quot;User storage access already exists for user ID: &quot; + userStorageAccess.getUser().getId() +</span>
<span class="nc" id="L108">                                &quot; and storage ID: &quot; + userStorageAccess.getStorage().getId());</span>
            }
<span class="nc" id="L110">            throw e;</span>
<span class="nc" id="L111">        }</span>
<span class="nc" id="L112">    }</span>

    @Override
    
    public void delete(Long id) {
<span class="nc" id="L117">        log.info(&quot;Deleting user storage access with ID: {}&quot;, id);</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!userStorageAccessRepository.existsById(id)) {</span>
<span class="nc" id="L120">            throw new UserStorageAccessNotFoundException(&quot;User storage access not found with ID: &quot; + id);</span>
        }

<span class="nc" id="L123">        userStorageAccessRepository.deleteById(id);</span>
<span class="nc" id="L124">        log.info(&quot;User storage access with ID: {} deleted successfully&quot;, id);</span>
<span class="nc" id="L125">    }</span>

    @Override
    public Page&lt;UserStorageAccess&gt; findPage(int page, int size, Long userId, Long storageId,
                                               AccessLevel accessLevel, Boolean active) {
<span class="nc" id="L130">        log.debug(&quot;Fetching user storage access page - page: {}, size: {}, userId: {}, storageId: {}, accessLevel: {}, active: {}&quot;,</span>
<span class="nc" id="L131">                page, size, userId, storageId, accessLevel, active);</span>

<span class="nc" id="L133">        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, &quot;grantedAt&quot;));</span>

        Page&lt;UserStorageAccess&gt; accessPage;

<span class="nc bnc" id="L137" title="All 8 branches missed.">        if (userId != null &amp;&amp; storageId != null &amp;&amp; accessLevel != null &amp;&amp; active != null) {</span>
<span class="nc" id="L138">            accessPage = userStorageAccessRepository.findByUserIdAndStorageIdAndAccessLevelAndIsActive(</span>
                    userId, storageId, accessLevel, active, pageable);
<span class="nc bnc" id="L140" title="All 6 branches missed.">        } else if (userId != null &amp;&amp; storageId != null &amp;&amp; accessLevel != null) {</span>
<span class="nc" id="L141">            accessPage = userStorageAccessRepository.findByUserIdAndStorageIdAndAccessLevel(</span>
                    userId, storageId, accessLevel, pageable);
<span class="nc bnc" id="L143" title="All 6 branches missed.">        } else if (userId != null &amp;&amp; storageId != null &amp;&amp; active != null) {</span>
<span class="nc" id="L144">            accessPage = userStorageAccessRepository.findByUserIdAndStorageIdAndIsActive(</span>
                    userId, storageId, active, pageable);
<span class="nc bnc" id="L146" title="All 6 branches missed.">        } else if (userId != null &amp;&amp; accessLevel != null &amp;&amp; active != null) {</span>
<span class="nc" id="L147">            accessPage = userStorageAccessRepository.findByUserIdAndAccessLevelAndIsActive(</span>
                    userId, accessLevel, active, pageable);
<span class="nc bnc" id="L149" title="All 6 branches missed.">        } else if (storageId != null &amp;&amp; accessLevel != null &amp;&amp; active != null) {</span>
<span class="nc" id="L150">            accessPage = userStorageAccessRepository.findByStorageIdAndAccessLevelAndIsActive(</span>
                    storageId, accessLevel, active, pageable);
<span class="nc bnc" id="L152" title="All 4 branches missed.">        } else if (userId != null &amp;&amp; storageId != null) {</span>
<span class="nc" id="L153">            accessPage = userStorageAccessRepository.findByUserIdAndStorageId(userId, storageId, pageable);</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">        } else if (userId != null &amp;&amp; accessLevel != null) {</span>
<span class="nc" id="L155">            accessPage = userStorageAccessRepository.findByUserIdAndAccessLevel(userId, accessLevel, pageable);</span>
<span class="nc bnc" id="L156" title="All 4 branches missed.">        } else if (userId != null &amp;&amp; active != null) {</span>
<span class="nc" id="L157">            accessPage = userStorageAccessRepository.findByUserIdAndIsActive(userId, active, pageable);</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">        } else if (storageId != null &amp;&amp; accessLevel != null) {</span>
<span class="nc" id="L159">            accessPage = userStorageAccessRepository.findByStorageIdAndAccessLevel(storageId, accessLevel, pageable);</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">        } else if (storageId != null &amp;&amp; active != null) {</span>
<span class="nc" id="L161">            accessPage = userStorageAccessRepository.findByStorageIdAndIsActive(storageId, active, pageable);</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">        } else if (accessLevel != null &amp;&amp; active != null) {</span>
<span class="nc" id="L163">            accessPage = userStorageAccessRepository.findByAccessLevelAndIsActive(accessLevel, active, pageable);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (userId != null) {</span>
<span class="nc" id="L165">            accessPage = userStorageAccessRepository.findByUserId(userId, pageable);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        } else if (storageId != null) {</span>
<span class="nc" id="L167">            accessPage = userStorageAccessRepository.findByStorageId(storageId, pageable);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        } else if (accessLevel != null) {</span>
<span class="nc" id="L169">            accessPage = userStorageAccessRepository.findByAccessLevel(accessLevel, pageable);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        } else if (active != null) {</span>
<span class="nc" id="L171">            accessPage = userStorageAccessRepository.findByIsActive(active, pageable);</span>
        } else {
<span class="nc" id="L173">            accessPage = userStorageAccessRepository.findAll(pageable);</span>
        }

<span class="nc" id="L176">        return accessPage;</span>
    }

    private void updateRelatedEntities(UserStorageAccess access, UserStorageAccess userStorageAccess) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!access.getUser().getId().equals(userStorageAccess.getUser().getId())) {</span>
<span class="nc" id="L181">            User user = userService.getUserById(userStorageAccess.getUser().getId());</span>
<span class="nc" id="L182">            access.setUser(user);</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (userStorageAccessRepository.existsByUserIdAndStorageIdAndIdNot(</span>
<span class="nc" id="L185">                    userStorageAccess.getUser().getId(), userStorageAccess.getStorage().getId(), access.getId())) {</span>
<span class="nc" id="L186">                throw new DuplicateUserStorageAccessException(</span>
<span class="nc" id="L187">                        &quot;User storage access already exists for user ID: &quot; + userStorageAccess.getUser().getId() +</span>
<span class="nc" id="L188">                                &quot; and storage ID: &quot; + userStorageAccess.getStorage().getId());</span>
            }
        }

<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (!access.getStorage().getId().equals(userStorageAccess.getStorage().getId())) {</span>
<span class="nc" id="L193">            Storage storage = storageService.getById(userStorageAccess.getStorage().getId());</span>
<span class="nc" id="L194">            access.setStorage(storage);</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (userStorageAccessRepository.existsByUserIdAndStorageIdAndIdNot(</span>
<span class="nc" id="L197">                    userStorageAccess.getUser().getId(), userStorageAccess.getStorage().getId(), access.getId())) {</span>
<span class="nc" id="L198">                throw new DuplicateUserStorageAccessException(</span>
<span class="nc" id="L199">                        &quot;User storage access already exists for user ID: &quot; + userStorageAccess.getUser().getId() +</span>
<span class="nc" id="L200">                                &quot; and storage ID: &quot; + userStorageAccess.getStorage().getId());</span>
            }
        }

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!access.getGrantedBy().getId().equals(userStorageAccess.getGrantedBy().getId())) {</span>
<span class="nc" id="L205">            User grantedBy = userService.getUserById(userStorageAccess.getGrantedBy().getId());</span>
<span class="nc" id="L206">            access.setGrantedBy(grantedBy);</span>
        }
<span class="nc" id="L208">    }</span>


    public UserStorageAccess findByUserAndStorage(Long userId, Long storageId) {
<span class="nc" id="L212">        log.debug(&quot;Finding user storage access by userId: {} and storageId: {}&quot;, userId, storageId);</span>

<span class="nc" id="L214">        return userStorageAccessRepository.findByUserIdAndStorageId(userId, storageId)</span>
<span class="nc" id="L215">                .orElseThrow(() -&gt; new UserStorageAccessNotFoundException(</span>
                        &quot;User storage access not found for user ID: &quot; + userId + &quot; and storage ID: &quot; + storageId));
    }


    public boolean hasAccess(Long userId, Long storageId, AccessLevel requiredLevel) {
<span class="nc" id="L221">        log.debug(&quot;Checking access for userId: {}, storageId: {}, requiredLevel: {}&quot;, userId, storageId, requiredLevel);</span>

<span class="nc" id="L223">        UserStorageAccess access = userStorageAccessRepository.findByUserIdAndStorageId(userId, storageId)</span>
<span class="nc" id="L224">                .orElse(null);</span>

<span class="nc bnc" id="L226" title="All 4 branches missed.">        if (access == null || !access.getIsActive()) {</span>
<span class="nc" id="L227">            return false;</span>
        }

<span class="nc bnc" id="L230" title="All 4 branches missed.">        if (access.getExpiresAt() != null &amp;&amp; access.getExpiresAt().isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L231">            return false;</span>
        }

<span class="nc" id="L234">        return isAccessLevelSufficient(access.getAccessLevel(), requiredLevel);</span>
    }


    public UserStorageAccess deactivate(Long id) {
<span class="nc" id="L239">        log.info(&quot;Deactivating user storage access with ID: {}&quot;, id);</span>

<span class="nc" id="L241">        UserStorageAccess access = userStorageAccessRepository.findById(id)</span>
<span class="nc" id="L242">                .orElseThrow(() -&gt; new UserStorageAccessNotFoundException(&quot;User storage access not found with ID: &quot; + id));</span>

<span class="nc" id="L244">        access.setIsActive(false);</span>
<span class="nc" id="L245">        UserStorageAccess updatedAccess = userStorageAccessRepository.save(access);</span>

<span class="nc" id="L247">        log.info(&quot;User storage access with ID: {} deactivated successfully&quot;, id);</span>
<span class="nc" id="L248">        return updatedAccess;</span>
    }


    public UserStorageAccess activate(Long id) {
<span class="nc" id="L253">        log.info(&quot;Activating user storage access with ID: {}&quot;, id);</span>

<span class="nc" id="L255">        UserStorageAccess access = userStorageAccessRepository.findById(id)</span>
<span class="nc" id="L256">                .orElseThrow(() -&gt; new UserStorageAccessNotFoundException(&quot;User storage access not found with ID: &quot; + id));</span>

<span class="nc" id="L258">        access.setIsActive(true);</span>
<span class="nc" id="L259">        UserStorageAccess updatedAccess = userStorageAccessRepository.save(access);</span>

<span class="nc" id="L261">        log.info(&quot;User storage access with ID: {} activated successfully&quot;, id);</span>
<span class="nc" id="L262">        return updatedAccess;</span>
    }


    public List&lt;UserStorageAccess&gt; findByUser(Long userId) {
<span class="nc" id="L267">        log.debug(&quot;Finding all user storage accesses for userId: {}&quot;, userId);</span>

<span class="nc" id="L269">        return userStorageAccessRepository.findByUserId(userId);</span>
    }


    public List&lt;UserStorageAccess&gt; findByStorage(Long storageId) {
<span class="nc" id="L274">        log.debug(&quot;Finding all user storage accesses for storageId: {}&quot;, storageId);</span>

<span class="nc" id="L276">        return userStorageAccessRepository.findByStorageId(storageId);</span>
    }


    public List&lt;UserStorageAccess&gt; findExpiredAccesses() {
<span class="nc" id="L281">        log.debug(&quot;Finding all expired user storage accesses&quot;);</span>

<span class="nc" id="L283">        return userStorageAccessRepository.findExpiredAccesses(LocalDateTime.now());</span>
    }


    public void deactivateExpiredAccesses() {
<span class="nc" id="L288">        log.info(&quot;Deactivating expired user storage accesses&quot;);</span>

<span class="nc" id="L290">        List&lt;UserStorageAccess&gt; expiredAccesses = userStorageAccessRepository.findExpiredAccesses(LocalDateTime.now());</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (UserStorageAccess access : expiredAccesses) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (access.getIsActive()) {</span>
<span class="nc" id="L294">                access.setIsActive(false);</span>
<span class="nc" id="L295">                log.debug(&quot;Deactivated expired access with ID: {}&quot;, access.getId());</span>
            }
<span class="nc" id="L297">        }</span>

<span class="nc" id="L299">        userStorageAccessRepository.saveAll(expiredAccesses);</span>
<span class="nc" id="L300">        log.info(&quot;Deactivated {} expired user storage accesses&quot;, expiredAccesses.size());</span>
<span class="nc" id="L301">    }</span>

    private boolean isAccessLevelSufficient(AccessLevel userLevel, AccessLevel requiredLevel) {
<span class="nc bnc" id="L304" title="All 2 branches missed.">        return userLevel.ordinal() &gt;= requiredLevel.ordinal();</span>
    }

    public long countActiveAccessesByUser(Long userId) {
<span class="nc" id="L308">        log.debug(&quot;Counting active accesses for userId: {}&quot;, userId);</span>
<span class="nc" id="L309">        return userStorageAccessRepository.countByUserIdAndIsActive(userId, true);</span>
    }

    public long countActiveAccessesByStorage(Long storageId) {
<span class="nc" id="L313">        log.debug(&quot;Counting active accesses for storageId: {}&quot;, storageId);</span>
<span class="nc" id="L314">        return userStorageAccessRepository.countByStorageIdAndIsActive(storageId, true);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
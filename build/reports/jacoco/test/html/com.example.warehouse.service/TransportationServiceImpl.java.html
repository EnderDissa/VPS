<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransportationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">VPS</a> &gt; <a href="index.source.html" class="el_package">com.example.warehouse.service</a> &gt; <span class="el_source">TransportationServiceImpl.java</span></div><h1>TransportationServiceImpl.java</h1><pre class="source lang-java linenums">package com.example.warehouse.service;

import com.example.warehouse.dto.TransportationDTO;
import com.example.warehouse.entity.Transportation;
import com.example.warehouse.entity.Item;
import com.example.warehouse.entity.Vehicle;
import com.example.warehouse.entity.User;
import com.example.warehouse.entity.Storage;
import com.example.warehouse.enumeration.TransportStatus;
import com.example.warehouse.exception.TransportationNotFoundException;
import com.example.warehouse.exception.ItemNotFoundException;
import com.example.warehouse.exception.VehicleNotFoundException;
import com.example.warehouse.exception.UserNotFoundException;
import com.example.warehouse.exception.StorageNotFoundException;
import com.example.warehouse.exception.OperationNotAllowedException;
import com.example.warehouse.mapper.TransportationMapper;
import com.example.warehouse.repository.TransportationRepository;
import com.example.warehouse.repository.ItemRepository;
import com.example.warehouse.repository.VehicleRepository;
import com.example.warehouse.repository.UserRepository;
import com.example.warehouse.repository.StorageRepository;
import com.example.warehouse.service.interfaces.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

<span class="fc" id="L34">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class TransportationServiceImpl implements TransportationService {

    private final TransportationRepository transportationRepository;
    private final ItemService itemService;
    private final VehicleService vehicleService;
    private final UserService userService;
    private final StorageService storageService;

    @Override
    public Transportation create(Transportation transportation) {
<span class="fc" id="L47">        log.info(&quot;Creating new transportation for item ID: {} from storage {} to storage {}&quot;,</span>
<span class="fc" id="L48">                transportation.getItem().getId(), transportation.getFromStorage().getId(), transportation.getToStorage().getId());</span>

<span class="fc" id="L50">        Item item = itemService.getById(transportation.getItem().getId());</span>

<span class="fc" id="L52">        Vehicle vehicle = vehicleService.getById(transportation.getVehicle().getId());</span>

<span class="fc" id="L54">        User driver = userService.getUserById(transportation.getDriver().getId());</span>

<span class="fc" id="L56">        Storage fromStorage = storageService.getById(transportation.getFromStorage().getId());</span>

<span class="fc" id="L58">        Storage toStorage = storageService.getById(transportation.getToStorage().getId());</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (transportation.getFromStorage().getId().equals(transportation.getToStorage().getId())) {</span>
<span class="fc" id="L61">            throw new OperationNotAllowedException(&quot;From and to storage cannot be the same&quot;);</span>
        }

<span class="fc" id="L64">        checkDriverAvailability(transportation.getDriver().getId(), transportation.getScheduledDeparture(), transportation.getScheduledArrival());</span>
<span class="fc" id="L65">        checkVehicleAvailability(transportation.getVehicle().getId(), transportation.getScheduledDeparture(), transportation.getScheduledArrival());</span>

<span class="fc" id="L67">        transportation.setItem(item);</span>
<span class="fc" id="L68">        transportation.setVehicle(vehicle);</span>
<span class="fc" id="L69">        transportation.setDriver(driver);</span>
<span class="fc" id="L70">        transportation.setFromStorage(fromStorage);</span>
<span class="fc" id="L71">        transportation.setToStorage(toStorage);</span>
<span class="fc" id="L72">        transportation.setStatus(TransportStatus.PLANNED);</span>

<span class="fc" id="L74">        Transportation savedTransportation = transportationRepository.save(transportation);</span>
<span class="fc" id="L75">        log.info(&quot;Transportation created successfully with ID: {}&quot;, savedTransportation.getId());</span>

<span class="fc" id="L77">        return savedTransportation;</span>
    }

    @Override
    public Transportation getById(Long id) {
<span class="fc" id="L82">        log.debug(&quot;Fetching transportation by ID: {}&quot;, id);</span>

<span class="fc" id="L84">        return transportationRepository.findById(id)</span>
<span class="fc" id="L85">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>
    }

    @Override
    public void update(Long id, Transportation transportation) {
<span class="fc" id="L90">        log.info(&quot;Updating transportation with ID: {}&quot;, id);</span>

<span class="fc" id="L92">        Transportation existingTransportation = transportationRepository.findById(id)</span>
<span class="fc" id="L93">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>

<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (isFinalStatus(existingTransportation.getStatus())) {</span>
<span class="fc" id="L96">            throw new OperationNotAllowedException(</span>
<span class="fc" id="L97">                    &quot;Cannot update transportation with status: &quot; + existingTransportation.getStatus());</span>
        }

<span class="fc" id="L100">        updateRelatedEntities(existingTransportation, transportation);</span>

<span class="fc" id="L102">        existingTransportation.setStatus(transportation.getStatus());</span>
<span class="fc" id="L103">        existingTransportation.setScheduledDeparture(transportation.getScheduledDeparture());</span>
<span class="fc" id="L104">        existingTransportation.setScheduledArrival(transportation.getScheduledArrival());</span>

<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (transportation.getStatus() == TransportStatus.IN_TRANSIT &amp;&amp;</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                existingTransportation.getActualDeparture() == null) {</span>
<span class="fc" id="L108">            existingTransportation.setActualDeparture(LocalDateTime.now());</span>
        }

<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (transportation.getStatus() == TransportStatus.DELIVERED &amp;&amp;</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                existingTransportation.getActualArrival() == null) {</span>
<span class="fc" id="L113">            existingTransportation.setActualArrival(LocalDateTime.now());</span>
        }

<span class="fc" id="L116">        transportationRepository.save(existingTransportation);</span>
<span class="fc" id="L117">        log.info(&quot;Transportation with ID: {} updated successfully&quot;, id);</span>
<span class="fc" id="L118">    }</span>

    @Override
    public void delete(Long id) {
<span class="fc" id="L122">        log.info(&quot;Deleting transportation with ID: {}&quot;, id);</span>

<span class="fc" id="L124">        Transportation transportation = transportationRepository.findById(id)</span>
<span class="fc" id="L125">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>

<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (isFinalStatus(transportation.getStatus())) {</span>
<span class="fc" id="L128">            throw new OperationNotAllowedException(</span>
<span class="fc" id="L129">                    &quot;Cannot delete transportation with status: &quot; + transportation.getStatus());</span>
        }

<span class="fc" id="L132">        transportationRepository.deleteById(id);</span>
<span class="fc" id="L133">        log.info(&quot;Transportation with ID: {} deleted successfully&quot;, id);</span>
<span class="fc" id="L134">    }</span>

    @Override
    public Page&lt;Transportation&gt; findPage(int page, int size, TransportStatus status, Long itemId,
                                            Long fromStorageId, Long toStorageId) {
<span class="fc" id="L139">        log.debug(&quot;Fetching transportations page - page: {}, size: {}, status: {}, itemId: {}, fromStorageId: {}, toStorageId: {}&quot;,</span>
<span class="fc" id="L140">                page, size, status, itemId, fromStorageId, toStorageId);</span>

<span class="fc" id="L142">        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;));</span>

        Page&lt;Transportation&gt; transportationsPage;

<span class="pc bpc" id="L146" title="2 of 8 branches missed.">        if (status != null &amp;&amp; itemId != null &amp;&amp; fromStorageId != null &amp;&amp; toStorageId != null) {</span>
<span class="fc" id="L147">            transportationsPage = transportationRepository.findByStatusAndItemIdAndFromStorageIdAndToStorageId(</span>
                    status, itemId, fromStorageId, toStorageId, pageable);
<span class="pc bpc" id="L149" title="1 of 4 branches missed.">        } else if (status != null &amp;&amp; itemId != null) {</span>
<span class="nc" id="L150">            transportationsPage = transportationRepository.findByStatusAndItemId(status, itemId, pageable);</span>
<span class="pc bpc" id="L151" title="1 of 4 branches missed.">        } else if (status != null &amp;&amp; fromStorageId != null) {</span>
<span class="nc" id="L152">            transportationsPage = transportationRepository.findByStatusAndFromStorageId(status, fromStorageId, pageable);</span>
<span class="pc bpc" id="L153" title="1 of 4 branches missed.">        } else if (status != null &amp;&amp; toStorageId != null) {</span>
<span class="nc" id="L154">            transportationsPage = transportationRepository.findByStatusAndToStorageId(status, toStorageId, pageable);</span>
<span class="pc bpc" id="L155" title="1 of 4 branches missed.">        } else if (itemId != null &amp;&amp; fromStorageId != null) {</span>
<span class="nc" id="L156">            transportationsPage = transportationRepository.findByItemIdAndFromStorageId(itemId, fromStorageId, pageable);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">        } else if (status != null) {</span>
<span class="fc" id="L158">            transportationsPage = transportationRepository.findByStatus(status, pageable);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        } else if (itemId != null) {</span>
<span class="fc" id="L160">            transportationsPage = transportationRepository.findByItemId(itemId, pageable);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        } else if (fromStorageId != null) {</span>
<span class="fc" id="L162">            transportationsPage = transportationRepository.findByFromStorageId(fromStorageId, pageable);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        } else if (toStorageId != null) {</span>
<span class="fc" id="L164">            transportationsPage = transportationRepository.findByToStorageId(toStorageId, pageable);</span>
        } else {
<span class="fc" id="L166">            transportationsPage = transportationRepository.findAll(pageable);</span>
        }

<span class="fc" id="L169">        return transportationsPage;</span>
    }


    private void updateRelatedEntities(Transportation transportation, Transportation newTransportation) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (!transportation.getItem().getId().equals(newTransportation.getItem().getId())) {</span>
<span class="fc" id="L175">            Item item = itemService.getById(newTransportation.getItem().getId());</span>
<span class="fc" id="L176">            transportation.setItem(item);</span>
        }

<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (!transportation.getVehicle().getId().equals(newTransportation.getVehicle().getId())) {</span>
<span class="fc" id="L180">            Vehicle vehicle = vehicleService.getById(newTransportation.getVehicle().getId());</span>
<span class="fc" id="L181">            transportation.setVehicle(vehicle);</span>
        }

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (!transportation.getDriver().getId().equals(newTransportation.getDriver().getId())) {</span>
<span class="fc" id="L185">            User driver = userService.getUserById(newTransportation.getDriver().getId());</span>
<span class="fc" id="L186">            transportation.setDriver(driver);</span>
        }

<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (!transportation.getFromStorage().getId().equals(newTransportation.getFromStorage().getId())) {</span>
<span class="fc" id="L190">            Storage fromStorage = storageService.getById(newTransportation.getFromStorage().getId());</span>
<span class="fc" id="L191">            transportation.setFromStorage(fromStorage);</span>
        }

<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (!transportation.getToStorage().getId().equals(newTransportation.getToStorage().getId())) {</span>
<span class="fc" id="L195">            Storage toStorage = storageService.getById(newTransportation.getToStorage().getId());</span>
<span class="fc" id="L196">            transportation.setToStorage(toStorage);</span>
        }
<span class="fc" id="L198">    }</span>

    private void checkDriverAvailability(Long driverId, LocalDateTime start, LocalDateTime end) {
<span class="pc bpc" id="L201" title="3 of 4 branches missed.">        if (start != null &amp;&amp; end != null) {</span>
<span class="nc" id="L202">            boolean isAvailable = transportationRepository.isDriverAvailable(driverId, start, end);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (!isAvailable) {</span>
<span class="nc" id="L204">                throw new OperationNotAllowedException(&quot;Driver is not available during the specified time period&quot;);</span>
            }
        }
<span class="fc" id="L207">    }</span>

    private void checkVehicleAvailability(Long vehicleId, LocalDateTime start, LocalDateTime end) {
<span class="pc bpc" id="L210" title="3 of 4 branches missed.">        if (start != null &amp;&amp; end != null) {</span>
<span class="nc" id="L211">            boolean isAvailable = transportationRepository.isVehicleAvailable(vehicleId, start, end);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (!isAvailable) {</span>
<span class="nc" id="L213">                throw new OperationNotAllowedException(&quot;Vehicle is not available during the specified time period&quot;);</span>
            }
        }
<span class="fc" id="L216">    }</span>

    private boolean isFinalStatus(TransportStatus status) {
<span class="pc bpc" id="L219" title="1 of 4 branches missed.">        return status == TransportStatus.DELIVERED || status == TransportStatus.CANCELLED;</span>
    }


    public Transportation startTransportation(Long id) {
<span class="fc" id="L224">        log.info(&quot;Starting transportation with ID: {}&quot;, id);</span>

<span class="fc" id="L226">        Transportation transportation = transportationRepository.findById(id)</span>
<span class="pc" id="L227">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>

<span class="fc bfc" id="L229" title="All 2 branches covered.">        if (transportation.getStatus() != TransportStatus.PLANNED) {</span>
<span class="fc" id="L230">            throw new OperationNotAllowedException(</span>
<span class="fc" id="L231">                    &quot;Cannot start transportation with status: &quot; + transportation.getStatus());</span>
        }

<span class="fc" id="L234">        transportation.setStatus(TransportStatus.IN_TRANSIT);</span>
<span class="fc" id="L235">        transportation.setActualDeparture(LocalDateTime.now());</span>

<span class="fc" id="L237">        Transportation updatedTransportation = transportationRepository.save(transportation);</span>
<span class="fc" id="L238">        log.info(&quot;Transportation with ID: {} started successfully&quot;, id);</span>

<span class="fc" id="L240">        return updatedTransportation;</span>
    }

    public Transportation completeTransportation(Long id) {
<span class="fc" id="L244">        log.info(&quot;Completing transportation with ID: {}&quot;, id);</span>

<span class="fc" id="L246">        Transportation transportation = transportationRepository.findById(id)</span>
<span class="pc" id="L247">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>

<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (transportation.getStatus() != TransportStatus.IN_TRANSIT) {</span>
<span class="fc" id="L250">            throw new OperationNotAllowedException(</span>
<span class="fc" id="L251">                    &quot;Cannot complete transportation with status: &quot; + transportation.getStatus());</span>
        }

<span class="fc" id="L254">        transportation.setStatus(TransportStatus.DELIVERED);</span>
<span class="fc" id="L255">        transportation.setActualArrival(LocalDateTime.now());</span>

<span class="fc" id="L257">        Transportation updatedTransportation = transportationRepository.save(transportation);</span>
<span class="fc" id="L258">        log.info(&quot;Transportation with ID: {} completed successfully&quot;, id);</span>

<span class="fc" id="L260">        return updatedTransportation;</span>
    }

    public Transportation cancelTransportation(Long id) {
<span class="fc" id="L264">        log.info(&quot;Canceling transportation with ID: {}&quot;, id);</span>

<span class="fc" id="L266">        Transportation transportation = transportationRepository.findById(id)</span>
<span class="pc" id="L267">                .orElseThrow(() -&gt; new TransportationNotFoundException(&quot;Transportation not found with ID: &quot; + id));</span>

<span class="fc bfc" id="L269" title="All 2 branches covered.">        if (isFinalStatus(transportation.getStatus())) {</span>
<span class="fc" id="L270">            throw new OperationNotAllowedException(</span>
<span class="fc" id="L271">                    &quot;Cannot cancel transportation with status: &quot; + transportation.getStatus());</span>
        }

<span class="fc" id="L274">        transportation.setStatus(TransportStatus.CANCELLED);</span>

<span class="fc" id="L276">        Transportation updatedTransportation = transportationRepository.save(transportation);</span>
<span class="fc" id="L277">        log.info(&quot;Transportation with ID: {} cancelled successfully&quot;, id);</span>

<span class="fc" id="L279">        return updatedTransportation;</span>
    }

    public Page&lt;Transportation&gt; findOverdueTransportations(int page, int size) {
<span class="nc" id="L283">        log.debug(&quot;Fetching overdue transportations - page: {}, size: {}&quot;, page, size);</span>

<span class="nc" id="L285">        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.ASC, &quot;scheduledArrival&quot;));</span>
<span class="nc" id="L286">        LocalDateTime now = LocalDateTime.now();</span>

<span class="nc" id="L288">        return transportationRepository.findOverdueTransportations(now, pageable);</span>
    }

    public long countByStatus(TransportStatus status) {
<span class="fc" id="L292">        log.debug(&quot;Counting transportations with status: {}&quot;, status);</span>
<span class="fc" id="L293">        return transportationRepository.countByStatus(status);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>